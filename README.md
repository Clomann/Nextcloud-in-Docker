
# Nextcloud + docker
This repository contains the Dockerfiles and docker-compose files
and some additional scripts to run following setup:

- container from custom nextcloud + php image based on Debian
- nginx container
- mariadb container
- mariabackup container

## How to use
Edit and run the script "run-docker-compose.command" to set 
needed environment variables and call docker-compose.

`INFO`: Remember to change the password string used in /db/backup.sh in accordance to the environment variable `MYSQL_ROOT_PASSWORD` (e.g. created in the script run-docker-compose.command). It is used to access the database in the /db/backup.sh script and assigned to the variable `DB_PWD`.

## Backup
Backups are generated by registering a crontab that runs the script "/db/backup.sh" regurlarly and incrementally. 

### Restoring backups
This chapter explains how to restore a backup.

#### Nextcloud data + config backup
This section briefly explains the content of the nextcloud data and config folders and shows the steps on how to apply backups.

##### Description
This section briefly describes the content of the nexctloud data and config folders.

###### Nextcloud Data Folder (/var/www/html/data)
The data folder contains all user-uploaded files and directories. Each user has a dedicated subdirectory:

User Files & Folders – The actual user-uploaded content.
Thumbnails – Generated previews of images and documents.
Encryption Keys – If encryption is enabled, private keys for encrypted files.
Trash & Versions – Deleted files (trashbin) and previous versions of modified files.
Lock Files – Temporary files used to manage file locking to prevent conflicts in collaborative editing.

###### Nextcloud Config Folder (/var/www/html/config)
The config folder holds Nextcloud’s configuration settings. The main file is:

- config.php – The primary Nextcloud configuration file containing:
  - Database connection details (username, password, host, database name)
  - Trusted domains and URLs
  - Admin account details
  - Logging settings
  - Installed apps and feature flags
  - Cache and memory settings
  - SMTP email configuration
  - Encryption and security settings

Other files in the config directory may include:

- config.sample.php – A template configuration file.
- App-specific configuration files – Some Nextcloud apps store additional settings here.


##### How to resore the backup
To restore both folders edit the `Folder` variable in the following command so it corresponds to an existing folder in the incremental backup folders and run it:

```
FOLDER=20250201_165402 && rsync -a --progress --delete  /backup/nextcloud_data/$FOLDER/ /var/www/html/nextcloud/data/ && rsync -a --progress --delete /backup/nextcloud_config/$FOLDER/ /var/www/html/nextcloud/config/
```


#### MariaDB backup (/var/lib/mysql)
This section briefly explains the content of the MariaDB database and shows the steps on how to apply backups.


##### Description
MariaDB (or MySQL) stores metadata and application-related data for Nextcloud, including:

- ser Accounts – Usernames, hashed passwords, email addresses, and group memberships.
- File Metadata – Information about uploaded files such as filenames, sizes, timestamps, and versions.
- Sharing Information – Data about file and folder shares, including internal user shares and public share links.
- Activity Logs – User activities such as file uploads, downloads, and edits.
- App Configuration – Settings for Nextcloud and installed apps, such as enabled features, encryption settings, and external storage configurations.
- Sessions and Tokens – Login sessions, two-factor authentication tokens, and remembered device sessions.
- Contacts, Calendar, and Notes Data – If Nextcloud apps like Contacts, Calendar, or Notes are used, their data is stored in the database.

##### How to resore the backup
Since MariaDB cannot be running when replacing its data files, stop it first (or stop the container):
```
service mariadb stop
```

Before restoring, you must prepare the full backup. This step ensures that the backup is consistent and applies any uncommitted transactions:

```
mariabackup --prepare --target-dir="/backup/full/base"
```

If you have incremental backups, apply them in chronological order (oldest to newest), modifying the full backup to reflect the latest changes:

```
mariabackup --prepare --target-dir=/backup/full/base --incremental-dir=/backup/incremental/<oldest-timestamp>

mariabackup --prepare --target-dir=/backup/full/base --incremental-dir=/backup/incremental/<next-timestamp>

mariabackup --prepare --target-dir=/backup/full/base --incremental-dir=/backup/incremental/<newest-timestamp>
```

To avoid conflicts, delete the old database files:

```
rm -rf /var/lib/mysql/*
```

Once the backup is fully prepared (full + incremental backups applied), restore it to the original MariaDB data directory:

mariabackup --copy-back --target-dir=/backup/full/base

```
mariabackup --copy-back --target-dir="/backup/full/base"
```

Ensure that MariaDB owns the restored files:

```
chown -R mysql:mysql /var/lib/mysql
```

Now start the database service again (or startup the container):

```
docker-compose restart db
```

Check if the databases are correctly restored:

```
mysql -u root -p -e "SHOW DATABASES;"
```

# Notes
## Commands used for debugging

docker build -t nextcloud_custom .

docker-compose up -d --build

sed -i 's|^;listen.mode =.*|listen.mode = 0660|' /etc/php/8.2/fpm/pool.d/www.conf

cat /etc/php/8.2/fpm/pool.d/www.conf | grep -E 'listen|user|group|mode'

openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout nginx/ssl/nextcloud.key -out nginx/ssl/nextcloud.crt \
  -subj "/CN=localhost"
